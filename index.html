<!--
/*
 * Copyright 2014, Gregg Tavares.
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Gregg Tavares. nor the names of its
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <title>Fan Fiction Reader</title>

  <link rel="icon" type="image/png" href="icon.png" />

  <meta property="og:title" content="Fan Fiction Reader" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="https://greggman.github.io/fanfictionreader/thumbnail.png" />
  <meta property="og:description" content="Fancy your favorite fan fiction read to you?" />
  <meta property="og:url" content="https://greggman.github.io/fanfictionreader/" />

  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="@greggman" />
  <meta name="twitter:creator" content="@greggman" />
  <meta name="twitter:domain" content="greggman.github.io" />
  <meta name="twitter:title" content="Fan Fiction Reader" />
  <meta name="twitter:url" content="https://greggman.github.io/fanfictionreader/" />
  <meta name="twitter:description" content="Fancy your favorite fan fiction read to you?" />
  <meta name="twitter:image:src" content="https://greggman.github.io/fanfictionreader/thumbnail.png" />

  <style>
    * {
      box-sizing: border-box;
      -moz-box-sizing: border-box;
    }
    body {
        background-color: rgb(255, 89, 248);
        color: white;
        font-size: large;
        margin: 0;
    }
    .header {
        background: #de36c2;
        margin-bottom: 1em;
        border-radius: .75em;
        padding: 1em;
    }
    h1 {
        margin: 0;
    }
    .outer {
        width: 100vw;
        height: 100vh;
        padding: 1em;
        display: flex;
        flex-direction: column;
    }
    input, select {
      width: 300px;
    }
    select {
      font-size: large;
      background: rgb(247, 83, 255);
      color: white;
      border: none;
    }
    body, button, textarea {
      font-family: sans-serif;
    }
    textarea {
      padding: 1em;
      flex: 1 1 auto;
      background: #d70c91;;
      color: #EEE;
      font-size: medium;
      display: block;
      border-radius: 1em;
      border: none;
    }
    button {
        border-radius: 20px;
        background: #cb4ea5;
        color: #fff;
        box-shadow: 0 6px #ab3c3c;
        -webkit-transition: none;
        -moz-transition: none;
        border: none;
        font-family: inherit;
        font-size: inherit;
        cursor: pointer;
        padding: 25px 40px;
        display: inline-block;
        margin: 15px 10px 15px 0;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 700;
        outline: none;
        position: relative;
        transition: all 0.3s;
    }
    .settings>div>div>span {
        position: absolute;
        left: 340px;
    }
    .settings>div {
        margin: .2em;
        padding: .2em;
        width: 410px;
        background: #de36c2;
        border-radius: .5em;
    }
    .settings>div>div {
        display: table-cell;
        vertical-align: middle;
    }
    .warn {
      color: red;
    }

    @media (max-width: 440px) {
        input, select {
          width: 200px;
        }
        .settings>div {
            width: 300px;
        }
        .settings>div>div>span {
            left: 240px;
        }
    }

    #url { display: none; }
  </style>
</head>
<body>
<div class="outer">
  <div class="header">
    <h1>Fan Fiction Reader</h1>
    <div>paste in some text, select a voice, click talk...</div>
  </div>
  <textarea id="t"></textarea>
  <div>
    <button id="talk">talk</button><button id="stop">stop</button><button id="url">get url</button>
    <div class="settings">
      <div><div><input type="range" value="1" id="rate"  step="0.1" min="0.1" max="4" /></div></div>
      <div><div><input type="range" value="1" id="pitch" step="0.1" min="0"   max="2"  /></div></div>
      <div><div><select id="v"></select><span>voice:</span></div>
    </div>
  </div>
</div>
<script src="js/lzma.js"></script>
<script>
const compressor = new LZMA( "js/lzma_worker.js" );

function main() {
  const $ = document.querySelector.bind(document);

  const t = $('#t');
  const v = $('#v');
  const talk = $('#talk');
  const stop = $('#stop');
  const getUrl = $('#url');
  const googleApiKey = 'AIzaSyDGvzuv_UPR5p-m0i3eq4pCU4DkXreVsE8';
  const bitlyAccessToken = '6b7d8faca9af4e56031431782896ab7bf5cc1016';

  const settings = {
    pitch: 1,
    rate: 1,
    text: '"Paste some fan fiction here, then press talk" Miku suggested, excitedly!',
  };

  const ui = [
  ];

  [].forEach.call(document.querySelectorAll('input'), (rangeElem) => {
    const labelElem = document.createElement('span');
    labelElem.appendChild(document.createTextNode(rangeElem.id + ': '));
    const valueElem = document.createElement('span');
    const valueText = document.createTextNode(rangeElem.value);
    valueElem.appendChild(labelElem);
    valueElem.appendChild(valueText);
    rangeElem.parentElement.insertBefore(valueElem, rangeElem.nextSibling);
    const update = function() {
      settings[rangeElem.id] = rangeElem.value;
      valueText.nodeValue = rangeElem.value;
    };
    const set = function() {
      rangeElem.value = settings[rangeElem.id];
      valueText.nodeValue = settings[rangeElem.id];
    };
    rangeElem.addEventListener('change', update, false);
    rangeElem.addEventListener('input', update, false);
    update();
    ui.push(set);
  });


  let tries = 50;
  let voices;
  function getVoices() {
    voices = speechSynthesis.getVoices();
    if (!voices || voices.length === 0) {
      if (tries) {
        --tries;
        setTimeout(getVoices, 100);  // In chrome they are not ready immediately!???!
      } else {
        console.log('no voices');
        start();
      }
    } else {
      start();
    }
  }
  getVoices();

  function convertHexToBytes(text) {
    var array = [];
    for (var i = 0; i < text.length; i += 2) {
      var tmpHex = text.substring(i, i + 2);
      array.push(parseInt(tmpHex, 16));
    }
    return array;
  }

  function convertBytesToHex(byteArray) {
    var hex = '';
    for (var i = 0, il = byteArray.length; i < il; i++) {
      if (byteArray[i] < 0) {
        byteArray[i] = byteArray[i] + 256;
      }
      var tmpHex = byteArray[i].toString(16);
      // add leading zero
      if (tmpHex.length == 1) {
        tmpHex = '0' + tmpHex;
      }
      hex += tmpHex;
    }
    return hex;
  }

  function startTalking() {
    if (speechSynthesis.speaking) {
      stopTalking();
    }
    settings.text = t.value;
    const msg = new SpeechSynthesisUtterance(t.value);
    msg.volume = 1; // 0 to 1
    msg.rate = settings.rate;
    msg.pitch = settings.pitch;
    const vs = voices.filter(v => v.name === settings.voiceName);
    vs.push(voices[0]);
    msg.voice = vs[0];
    speechSynthesis.speak(msg);
    // setURL();
  }

  function stopTalking() {
    speechSynthesis.cancel();
  }

  function xhrJSON(url, obj) {
    return new Promise((resolve, reject) => {
      const xhr = new XMLHttpRequest();
      xhr.responseType = "json";
      xhr.open('POST', url);
      xhr.onload = function() {
        resolve(xhr.response);
      };
      xhr.onerror = function(e) {
        reject(e);
      };
      xhr.setRequestHeader('Content-Type', 'application/json');
      const data = JSON.stringify(obj);
      xhr.send(data);
      console.log('sent:', data);
    });
  }

  //function getShortUrl() {
  //  settings.text = t.value;
  //  compressor.compress(JSON.stringify(settings), 1, function(bytes) {
  //    const hex = convertBytesToHex(bytes);
  //    const url = window.location.origin + window.location.pathname + `#${hex}`;
  //    const api = `https://www.googleapis.com/urlshortener/v1/url?key=${googApiKey}`;
  //    xhrJSON(api, {
  //      longUrl: url,
  //    }).then((result) => {
  //      console.log(result);
  //    });
  //  },
  //  dummyFunction);
  //}

  function makeQuery(obj) {
    return Object.keys(obj).map((key) => {
      return `${encodeURIComponent(key)}=${encodeURIComponent(obj[key])}`;
    }).join('&');
  }

  function getShortUrl() {
    settings.text = t.value;
    compressor.compress(JSON.stringify(settings), 1, function(bytes) {
      const hex = convertBytesToHex(bytes);
      const url = window.location.origin + window.location.pathname + `#${hex}`;
      const data = {
        longUrl: url,
        access_token: bitlyAccessToken,
      }
      const api = `https://api-ssl.bitly.com/V3/SHORTEN?${makeQuery(data)}`;
      xhrJSON(api, {
        longUrl: url,
      }).then((result) => {
        console.log(result);
      });
    },
    dummyFunction);
  }

  function start2() {
    talk.addEventListener('click', startTalking, false);
    stop.addEventListener('click', stopTalking, false);
    window.addEventListener('unload', stopTalking, false);
    //getUrl.addEventListener('click', getShortUrl, false)
    startTalking();
  }

  function dummyFunction() {
    console.log("dummy");
  }

  let dontSet = true;
  function setURL() {
    if (dontSet) {
      dontSet = false;
      return;
    }
    compressor.compress(JSON.stringify(settings), 1, function(bytes) {
      var hex = convertBytesToHex(bytes);
      window.location.replace(`#${hex}`);
    },
    dummyFunction);
  }

  function readURL(hash) {
    const bytes = convertHexToBytes(hash);
    compressor.decompress(bytes, function(data, error) {
      if (error) {
        console.error(error);
      } else {
        try {
          const s = JSON.parse(data);
          Object.assign(settings, s);
        } catch (e) {
          console.error(e);
        }
      }
      updateUI();
      start2();
    },
    dummyFunction);
  }

  function getIndexOfVoiceByName(name) {
    for (let i = 0; i < voices.length; ++i) {
      if (voices[i].name === name) {
        return i;
      }
    }
    return 0;
  }

  function updateUI() {
    t.value = settings.text;
    ui.forEach((u) => u());
    v.selectedIndex = getIndexOfVoiceByName(settings.voiceName);
  }

  function start() {
    if (voices && voices.length) {
      voices.filter(v => v.localService).forEach(function(voice, ndx) {
        const opt = document.createElement('option');
        opt.appendChild(document.createTextNode(`${voice.name} [${voice.lang}]`));
        if (voice.name === 'Victoria') {
          settings.voiceName = voice.name;
        }
        if (voice.default) {
          settings.voiceName = settings.voiceName || voice.name;
        }
        v.appendChild(opt);
      });
      settings.voiceName = settings.voiceName || voice[0].name;
    }

    v.addEventListener('change', function(e) {
      settings.voiceName = voices[v.selectedIndex].name;
    }, false);

    if (window.location.hash) {
      var hash = window.location.hash.substr(1);
      readURL(hash);
    } else {
      //readURL('5d000001003417000000000000003d888a06d454b8e6fb4004418cc3d21eb284e2ececb9f187f491870a1349a00d0f2a249ec52b4029a93abc931aed85a9c1e073e82c7a20b2b518f907efb662304860cac9e9215b958fac4e1f6ded3829c06aaacf6d8bc0ce05ff4bfd5f58e3dcacab7c10058e840e8d258b01b0e862af5acefc12411d51410010e8b4ff52d66e9c69432acce503c36cf2b8825eccfc69254697eee9c9eb6a13b1c5b5933db9c77d9e66c1f3372409105dce5e1baf307a76234ca5a43ea510ffd66c46b64816d5e5c610300760e6dbca738f85393a9093b84d6e12c48bbab404c6a3090718c57d0a7a9d2258769ca806f8419b8cf6a03acdc2a47c0d01fbaf5fa8d1f5faab4a637143805c07381bc045cccffd3a6087afe8f116f59e09338919484d688f93d32733ef1be480c3ad9d66df0403bdd7e018f740bc5a9057cb432c669f56c8b32a4fcf5e4d24fdc9d3ed49b4033eafaa6dd928c0f1d011d88ab6a87c0bbb216a9c177ac027371197164c114027d1fcd10ba03554409cf7f411853dbc6d08075b0d14af6457fefe0ffd24b8a8851253f28649e9a29823baf8ee1996214c7eff86ba9ad55a1ffbfb782be6278beddf8b694b8346a2a50d30adbfe28e372b9983a0cd1fd430e72c3f878357f4df80f82507be63ca44f43bcda254060961d1dfa45491e83a0bde70bba3d295fc9d380924f75edfcd91cfe9f90c2f1c18441cbee170e8bcc30ddc34a2e047072f4d3f695a0324124adba39fbc44d21850014693a881f1a5df615967cc93fc7da9a91bed64b35c1c7a2da1cff8dfbe038e94f659785b222b79dba0b1f73a2fc706372bbfe15ff1c228a503bee1fadd83922e1c81671ea831881b78dfadd657fb74ec8a30c3cee00011a6e466ea5a00a14d925eedce1c9c28ea52ab9a2fcc2bc5e2b444ded5444ad5a8fd777fe84f33393a9e10639f3be19ad3a14fb44dec454442bc79ce096aa47040f8f201f5858111dbf33ed1dbe5d22c8297befcca92af3db737136c263290045fcb9f5c67237a949b9f4fa6e90e55dae709e2796c3eb30635d857a16c2ae6de3c7f466afdfb483e47830b33b4302908a0aa95625bb33dd7a92b87d040b260b36fa7b1a12be3abf472986859fa1d2a50c5f4b560a15ae97158d04895440690ba707867598c6a8d3125fcfa757e97d70f10d5a66623161901a81cf38934b5842aa041d26b3e4be60638784b230f67c0653d4858968562eb2fe59e61ba5e4e34cc9f2b5771315a756abaf4e6c0a8e48c64a85c1898191aa4e0ed1ce67e75b0255fa24a2369e8b12ac78613d6ed9e3ae89387315cd492376855821f4b7038d70bc76d27a0188e80c375719fd6e8dc7248925d90a006c77e2867f7a0e3fa611607d3311b8585140639a0afd261969e474483a6864585e6f942f579220d92f6a2985fdd717fda8deb7d6692c454f6d9bb8c40a19e3e1d3c18059b5401babf8b99d66b1cf12dfe2d19e80d5110f802073625fd8ff58c9f41fb754e9b6604bced3bcba823797e7b1f6a324342ed6ca7f9ad31a9359be2dc522c492329c19d271cef42ef72f46eba04b111fa0481e9c8c0053830ce3e4ceab86cb43509d36f21ddf7ced11ac4740aea06577e7a6c5aff27492ec8464c74537f1f0b88b6508f7daa6be06596bb52b0e8fb416e93631d74d07bc91a0444e8dfe8cd41bdb7b8a086848ad332194983dc7b49f490bd7c19da04cc7cb5cc55dfc9d9bfe8d870e7b8adb6511d84efafcaa25fe56d529869180d7f3fc67c7f004f1144d1724c1a0d3db1164f5ca5cbfda741fd179bfe8d639ab1655c8d2f554d1c1aa53cd25059acc3764fc5fb20a984b5544b1edfdfdc4877aa1e90d38e633a6bf8c8b2cc65aa04f258b3d8a860edde3799bc69c0f3f60b6884e7edc03ffa2eeebfbcd641d6e4b2ca8409c068d7b5d75db19bdc39d5ad12719267687bbed2defe0a56639e04f43cf396b0030b654ee1b87f3104929a6bb4be39e29aca32cf3de326646ab90b017f29e636fb1308aaa74c2a4fdeda9cda658f04fffb71b003304f3bdacde3b1cacda67716811d02506b7782f24d6ca39db7e2915776a2ee0a1327fd298e8edd9136153a2bf0b735a8eacb269ac9554fc436276458ab48082d28495f8e453ff87dcb394208ca8285d3a76ed1d7b5af0155bf612e9a4f8703973d6f26dd575efa0ae2b55e68aad35c8c3f5fff22606d00e3a4ec8b999b0f2e471bb0f54cede0845ec303849c2bb0652ea5be07b4538879e23ff46a5d17e251e5c0d848a99e1999bce7e7603602144d908b620c5945090ce9acf465e6011ad62ae564ed7b5d82916340ad9375f6f1f13299df2c5cc2dd7c3041041bc277127782d9307de0873cf0f18c1e36d4545d60f469ae01a6c64631c92a278edb6133e55f9bd625caaa14d6099754b96567693b6739c057d3a8988840e6c8abe7e293acffb07336b7d11d7b28d4ac7f22e3fd47908463d0aadecc4bad4d2ebf9bd823bd77df6a7d8c4a2770b637eb61fb15ade87f487b400417abc55f0388b659c9c446936789b150f4b6e675abe15a057995c8b0be6df8a817eab2c1c618003b89f189e3f1a0997a596f74330ba3ff65c943d52a46bb141e03d7dc0d92fd9734fd301b5d11acfc7c4b1f81a86f8e035427b6dce6aaf29a10271a6f743b46b50c9e6e5de0676aa4eb6b941048739026cd6da6a0ce9f314afb5f4796ceee3640f218583ae8e2e86bf551c568a335a1211f64eeeaddb4aebbc41af8124f2cc312e7f29b6272f4f854d96182088f92c97361bf1e451776b3e49257fc6a533f8051f110debedc977c5a0340591e3dbd82507b3016252c19fd5115dc27a7207fb94500583bbd734f67a3cf644faddf994a5962abc39e4d36061d42f72eb7e9ddb26f237c42a1f10104505ebf0587128aec250ce89b20a951fb917f17c8e2711766d11380aff61f0b7c4e100a1f909661b97725ac99764a2f430e861ed377cbc42bb925b7053f1b58965723cae843074d38456bf4badb38964736a2b76ce7606e88aca3415f98b906c65840bd6d03e0a4a568bb03c57730cc5127565f0d89be4d75e2634e26ba64c8f87fdbf2f54934cc2906a0a364b98d405b2df875a889a2249b4366d8592951d598003ca63e0dbe4794ac9b9bf4363db16db5a58fd3f3d61f2846ebeb380d73ae550a8e7bce458d74341fafcbb8a76d0aec4ad96ea6f454d0bbccffb49841e4');
      updateUI();
      start2();
    }
  }
}

main();
</script>
</body>
</html>

